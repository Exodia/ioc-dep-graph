<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <script src="d3.v3.min.js"></script>
    <script src="./mock.js"></script>
</head>

<style>
    .nodetext {
        font-size: 16px;
        font-family: SimSun sans-serif;
        fill: #000;
    }

    .linetext {
        font-size: 16px;
        font-family: SimSun sans-serif;
        fill: #0ff;
        fill-opacity: 0.0;
    }

    svg {
        display: block;
        width: 80%;
        margin: 10px auto;
        height: 600px;
    }

    circle {
        fill: #3e98c5;
    }

    .edge-line {
        stroke-width: 3;
        stroke: #ccc;
        marker-end: url(#arrow);
    }

</style>
<svg>
</svg>
<body>
<script>
    var data;
    window.addEventListener('message', function (event) {
        data = event.data;
        draw();
    }, false);
    draw();
    function draw() {
        var root = data;
        var width = window.innerWidth;
        var height = window.innerHeight;
        var radius = 20;

        d3.select('svg').remove();
        var svg = d3.select('body').append('svg');
        svg.append('marker').attr({
            id: 'arrow',
            viewBox: '0 0 10 10',
            refX: 0,
            refY: 5,
            markerUnits: 'strokeWidth',
            markerWidth: 4,
            markerHeight: 3,
            orient: 'auto'
        }).append('path').attr('d', 'M 0 0 L 10 5 L 0 10 z');

        var force = d3.layout.force().nodes(root.nodes).links(root.links).size([width, height]).
            linkDistance(200).charge(-1500).start();

        var edgesLine = svg.selectAll('.edge-line').data(root.links).enter().append('line').classed('edge-line', true);

        var edgesText = svg.selectAll('.linetext').data(root.links).enter()
            .append('text').attr('class', 'linetext').text(function (d) {
                return d.relation;
            });


        var nodesCircle = svg.selectAll('circle').data(root.nodes).enter().append('circle').attr('r', radius)
            .on('mouseover', function (d, i) {
                //显示连接线上的文字
                edgesText.style('fill-opacity', function (edge) {
                    if (edge.source === d || edge.target === d) {
                        return 1.0;
                    }
                });
            })
            .on('mouseout', function (d, i) {
                //隐去连接线上的文字
                edgesText.style('fill-opacity', function (edge) {
                    if (edge.source === d || edge.target === d) {
                        return 0.0;
                    }
                });
            }).call(force.drag);

        var textX = -20;
        var textY = 10;

        var nodes_text = svg.selectAll('.nodetext').data(root.nodes).enter().append('text').attr('class', 'nodetext')
            .attr('dx', textX).attr('dy', textY).text(function (d) {
                return d.id;
            });


        force.on('tick', function () {

            //限制结点的边界
            root.nodes.forEach(function (d, i) {
                d.x = d.x - radius / 2 < 0 ? radius / 2 : d.x;
                d.x = d.x + radius / 2 > width ? width - radius / 2 : d.x;
                d.y = d.y - radius / 2 < 0 ? radius / 2 : d.y;
                d.y = d.y + radius / 2 + textY > height ? height - radius / 2 - textY : d.y;
            });

            //更新连接线的位置
            edgesLine.attr('x1', function (d) { return d.source.x; });
            edgesLine.attr('y1', function (d) { return d.source.y; });
            edgesLine.attr('x2', function (d) { return d.target.x; });
            edgesLine.attr('y2', function (d) { return d.target.y; });

            //更新连接线上文字的位置
            edgesText.attr('x', function (d) { return (d.source.x + d.target.x) / 2; });
            edgesText.attr('y', function (d) { return (d.source.y + d.target.y) / 2; });


            //更新结点和文字
            nodesCircle.attr('cx', function (d) { return d.x - radius / 2; });
            nodesCircle.attr('cy', function (d) { return d.y - radius / 2; });

            nodes_text.attr('x', function (d) { return d.x });
            nodes_text.attr('y', function (d) { return d.y + radius / 2; });
        });
    }

</script>

</body>
</html>